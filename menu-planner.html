<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ammy's Choice ‚Äî Simple HTML Menu Planner</title>
  <style>
    :root {
      --orange: #f97316;
      --orange-dark: #ea580c;
      --bg: #fff7ed;
      --card: #ffffff;
      --muted: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(180deg, #fff7ed 0%, #ffedd5 100%);
      min-height: 100vh;
      color: #1f2937;
      padding: 24px;
    }
    .wrap { max-width: 900px; margin: 0 auto; }
    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      padding: 20px;
      margin-bottom: 16px;
    }
    h1 { margin: 0 0 8px; }
    p { margin: 0; color: var(--muted); }
    label { display:block; font-weight: 600; margin-bottom: 6px; }
    input, textarea {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    textarea { min-height: 88px; resize: vertical; }
    .grid { display:grid; gap: 12px; grid-template-columns: 1fr; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    button {
      border: 0;
      background: var(--orange);
      color: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }
    button:hover { background: var(--orange-dark); }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .ghost {
      background: #fff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    #status { font-size: 13px; color: #9a3412; min-height: 20px; }
    #menu {
      white-space: pre-wrap;
      background: #fff;
      border: 1px solid #fed7aa;
      border-radius: 12px;
      padding: 14px;
      line-height: 1.5;
      margin-top: 10px;
    }
    img {
      width: 100%;
      max-height: 340px;
      object-fit: cover;
      border-radius: 12px;
      margin-top: 12px;
      border: 1px solid #fde68a;
    }
    .small { font-size: 12px; color: var(--muted); }
    .ok { color: #166534; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üçõ Ammy's Choice ‚Äî HTML Version</h1>
      <p>No React app needed. Single HTML page that generates today‚Äôs menu.</p>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="geminiKey">Gemini API key (required)</label>
          <input id="geminiKey" type="password" placeholder="AIza..." />
        </div>
        <div>
          <label for="pexelsKey">Pexels API key (optional, for better menu image)</label>
          <input id="pexelsKey" type="password" placeholder="Optional" />
        </div>
        <div>
          <label for="prefs">Permanent preferences/dislikes</label>
          <textarea id="prefs" placeholder="No broccoli, low oil, no idli..."></textarea>
        </div>
      </div>
      <div class="row">
        <button id="generateBtn">Generate Menu</button>
        <button id="saveKeysBtn" class="ghost">Save Keys Locally</button>
        <button id="clearBtn" class="ghost">Clear Saved Preferences</button>
      </div>
      <div id="status"></div>
      <div class="small">Keys are only stored in your browser localStorage on this device.</div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Today‚Äôs Menu</h3>
      <div id="menu">Click ‚ÄúGenerate Menu‚Äù to begin.</div>
      <img id="menuImage" alt="Menu dish" style="display:none" />
      <div id="imageNote" class="small"></div>
    </div>
  </div>

  <script>
    const SYSTEM_INSTRUCTION = `You are the Meal Manager for a household of 3 vegetarians in Mumbai.
Generate breakfast, lunch, and dinner.
Keep it homely, healthy, and non-repetitive.
Return exactly this format:
Good Morning! Here is today's menu plan:\n\nüåû Breakfast: ...\nü•ò Lunch: ...\nüåô Dinner: ...`;

    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const saveKeysBtn = document.getElementById('saveKeysBtn');
    const statusEl = document.getElementById('status');
    const menuEl = document.getElementById('menu');
    const imageEl = document.getElementById('menuImage');
    const imageNote = document.getElementById('imageNote');
    const keyEl = document.getElementById('geminiKey');
    const pexelsEl = document.getElementById('pexelsKey');
    const prefsEl = document.getElementById('prefs');

    const STORE_PREFS = 'ammy_html_preferences';
    const STORE_GEMINI_KEY = 'ammy_html_gemini_key';
    const STORE_PEXELS_KEY = 'ammy_html_pexels_key';

    prefsEl.value = localStorage.getItem(STORE_PREFS) || '';
    keyEl.value = localStorage.getItem(STORE_GEMINI_KEY) || '';
    pexelsEl.value = localStorage.getItem(STORE_PEXELS_KEY) || '';

    saveKeysBtn.onclick = () => {
      localStorage.setItem(STORE_GEMINI_KEY, keyEl.value.trim());
      localStorage.setItem(STORE_PEXELS_KEY, pexelsEl.value.trim());
      statusEl.textContent = 'Keys saved locally in this browser.';
      statusEl.className = 'ok';
    };

    clearBtn.onclick = () => {
      localStorage.removeItem(STORE_PREFS);
      prefsEl.value = '';
      statusEl.textContent = 'Preferences cleared.';
      statusEl.className = 'ok';
    };

    function extractFirstDish(menuText) {
      const lines = menuText.split('\n').map(x => x.trim()).filter(Boolean);
      for (const line of lines) {
        if (line.includes('Breakfast') || line.includes('Lunch') || line.includes('Dinner')) {
          const part = line.split(':')[1] || '';
          const dish = part.split('+')[0].replace(/[üåûü•òüåô*]/g, '').trim();
          if (dish) return dish;
        }
      }
      return 'Indian vegetarian meal';
    }

    async function fetchPexelsImage(query, pexelsKey) {
      const res = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=1`, {
        headers: { Authorization: pexelsKey }
      });
      if (!res.ok) throw new Error('Pexels request failed');
      const data = await res.json();
      return data?.photos?.[0]?.src?.large2x || null;
    }

    generateBtn.onclick = async () => {
      const key = keyEl.value.trim();
      const prefs = prefsEl.value.trim();
      const pexelsKey = pexelsEl.value.trim();

      if (!key) {
        statusEl.textContent = 'Please provide Gemini API key.';
        statusEl.className = '';
        return;
      }

      localStorage.setItem(STORE_PREFS, prefs);
      localStorage.setItem(STORE_GEMINI_KEY, key);
      localStorage.setItem(STORE_PEXELS_KEY, pexelsKey);
      generateBtn.disabled = true;
      statusEl.textContent = 'Generating menu...';
      statusEl.className = '';
      imageEl.style.display = 'none';
      imageNote.textContent = '';

      const day = new Date().toLocaleDateString('en-IN', { weekday: 'long' });
      const prompt = `Today is ${day}.\nUser preferences/dislikes: ${prefs || 'None specified.'}\nGenerate a fresh menu.`;

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${encodeURIComponent(key)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] }
          })
        });

        if (!response.ok) {
          const errorBody = await response.text();
          throw new Error(`Gemini error ${response.status}: ${errorBody}`);
        }

        const data = await response.json();
        const text = data?.candidates?.[0]?.content?.parts?.map(p => p.text).join('\n') || 'No menu generated.';
        menuEl.textContent = text;
        statusEl.textContent = 'Menu generated successfully.';
        statusEl.className = 'ok';

        if (pexelsKey) {
          try {
            const dish = extractFirstDish(text);
            const imageUrl = await fetchPexelsImage(`${dish} indian vegetarian food`, pexelsKey);
            if (imageUrl) {
              imageEl.src = imageUrl;
              imageEl.style.display = 'block';
              imageNote.textContent = `Image based on: ${dish}`;
            } else {
              imageNote.textContent = 'No image found for this dish.';
            }
          } catch {
            imageNote.textContent = 'Image lookup failed. Check Pexels key or try again.';
          }
        } else {
          imageNote.textContent = 'Tip: add Pexels key for a more accurate dish image.';
        }
      } catch (err) {
        menuEl.textContent = 'Failed to generate menu.';
        statusEl.textContent = err.message;
        statusEl.className = '';
      } finally {
        generateBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
