<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ammy's Choice ‚Äî Simple HTML Menu Planner</title>
  <style>
    :root {
      --orange: #f97316;
      --orange-dark: #ea580c;
      --bg: #fff7ed;
      --card: #ffffff;
      --muted: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(180deg, #fff7ed 0%, #ffedd5 100%);
      min-height: 100vh;
      color: #1f2937;
      padding: 24px;
    }
    .wrap { max-width: 900px; margin: 0 auto; }
    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      padding: 20px;
      margin-bottom: 16px;
    }
    h1 { margin: 0 0 8px; }
    p { margin: 0; color: var(--muted); }
    label { display:block; font-weight: 600; margin-bottom: 6px; }
    textarea {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    textarea { min-height: 88px; resize: vertical; }
    .grid { display:grid; gap: 12px; grid-template-columns: 1fr; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .row-between { display:flex; justify-content: space-between; align-items:center; gap:8px; flex-wrap: wrap; }
    button {
      border: 0;
      background: var(--orange);
      color: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }
    button:hover { background: var(--orange-dark); }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .ghost {
      background: #fff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    #status { font-size: 13px; color: #9a3412; min-height: 20px; }
    #menu {
      white-space: pre-wrap;
      background: #fff;
      border: 1px solid #fed7aa;
      border-radius: 12px;
      padding: 14px;
      line-height: 1.5;
      margin-top: 10px;
    }
    img {
      width: 100%;
      max-height: 340px;
      object-fit: cover;
      border-radius: 12px;
      margin-top: 12px;
      border: 1px solid #fde68a;
    }
    .small { font-size: 12px; color: var(--muted); }
    .ok { color: #166534; }
    .meal-card {
      background: #fffaf5;
      border: 1px solid #fed7aa;
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
    }
    .meal-title { font-weight: 700; margin: 0 0 8px; }
    .meal-text { margin: 0; color: #374151; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üçõ Ammy's Choice ‚Äî HTML Version</h1>
      <p>No React app needed. Single HTML page that generates today‚Äôs menu.</p>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="prefs">Permanent preferences/dislikes</label>
          <textarea id="prefs" placeholder="No broccoli, low oil, no idli..."></textarea>
        </div>
      </div>
      <div class="row">
        <button id="generateBtn">Generate Menu</button>
        <button id="savePrefsBtn" class="ghost">Save Preferences</button>
        <button id="clearBtn" class="ghost">Clear Saved Preferences</button>
      </div>
      <div id="status"></div>
      <div class="small">Credentials are preconfigured in this page code.</div>
    </div>

    <div class="card">
      <div class="row-between">
        <h3 style="margin-top:0">Today‚Äôs Menu</h3>
        <div class="row">
          <button id="reshuffleAllBtn" class="ghost">Reshuffle Full Menu</button>
          <button id="voiceBtn" class="ghost">üîä Voice Output</button>
        </div>
      </div>
      <div id="menu">Click ‚ÄúGenerate Menu‚Äù to begin.</div>
      <div id="mealCards" style="display:none">
        <div class="meal-card">
          <div class="row-between">
            <p class="meal-title">üåû Breakfast</p>
            <button id="reshuffleBreakfastBtn" class="ghost">Reshuffle</button>
          </div>
          <p id="breakfastText" class="meal-text">-</p>
        </div>
        <div class="meal-card">
          <div class="row-between">
            <p class="meal-title">ü•ò Lunch</p>
            <button id="reshuffleLunchBtn" class="ghost">Reshuffle</button>
          </div>
          <p id="lunchText" class="meal-text">-</p>
        </div>
        <div class="meal-card">
          <div class="row-between">
            <p class="meal-title">üåô Dinner</p>
            <button id="reshuffleDinnerBtn" class="ghost">Reshuffle</button>
          </div>
          <p id="dinnerText" class="meal-text">-</p>
        </div>
      </div>
      <img id="menuImage" alt="Menu dish" style="display:none" />
      <div id="imageNote" class="small"></div>
    </div>
  </div>

  <script>
    const SYSTEM_INSTRUCTION = `You are the Meal Manager for a household of 3 vegetarians in Mumbai.
Generate breakfast, lunch, and dinner.
Keep it homely, healthy, and non-repetitive.
Return exactly this format:
Good Morning! Here is today's menu plan:\n\nüåû Breakfast: ...\nü•ò Lunch: ...\nüåô Dinner: ...`;
    const GEMINI_API_KEY = 'AIzaSyBCuw056u_WZcTDhSV-CF0qDAosuR03Y5g';
    const PEXELS_API_KEY = 'KBGQHtjULf9EYfXTYgHxSbGBIWmj8vZUj8hYMPWgRIbJuOOqo05U59cC';

    const generateBtn = document.getElementById('generateBtn');
    const savePrefsBtn = document.getElementById('savePrefsBtn');
    const clearBtn = document.getElementById('clearBtn');
    const reshuffleAllBtn = document.getElementById('reshuffleAllBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const statusEl = document.getElementById('status');
    const menuEl = document.getElementById('menu');
    const mealCards = document.getElementById('mealCards');
    const breakfastTextEl = document.getElementById('breakfastText');
    const lunchTextEl = document.getElementById('lunchText');
    const dinnerTextEl = document.getElementById('dinnerText');
    const reshuffleBreakfastBtn = document.getElementById('reshuffleBreakfastBtn');
    const reshuffleLunchBtn = document.getElementById('reshuffleLunchBtn');
    const reshuffleDinnerBtn = document.getElementById('reshuffleDinnerBtn');
    const imageEl = document.getElementById('menuImage');
    const imageNote = document.getElementById('imageNote');
    const prefsEl = document.getElementById('prefs');

    const STORE_PREFS = 'ammy_html_preferences';

    prefsEl.value = localStorage.getItem(STORE_PREFS) || '';

    const mealState = {
      breakfast: '',
      lunch: '',
      dinner: '',
      fullText: ''
    };

    function setBusy(isBusy) {
      generateBtn.disabled = isBusy;
      reshuffleAllBtn.disabled = isBusy;
      reshuffleBreakfastBtn.disabled = isBusy;
      reshuffleLunchBtn.disabled = isBusy;
      reshuffleDinnerBtn.disabled = isBusy;
    }

    clearBtn.onclick = () => {
      localStorage.removeItem(STORE_PREFS);
      prefsEl.value = '';
      statusEl.textContent = 'Preferences cleared.';
      statusEl.className = 'ok';
    };

    savePrefsBtn.onclick = () => {
      localStorage.setItem(STORE_PREFS, prefsEl.value.trim());
      statusEl.textContent = 'Preferences saved.';
      statusEl.className = 'ok';
    };

    voiceBtn.onclick = () => {
      if (!mealState.fullText || !('speechSynthesis' in window)) {
        statusEl.textContent = 'Voice output unavailable or menu not generated yet.';
        statusEl.className = '';
        return;
      }
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(mealState.fullText.replace(/[üåûü•òüåô]/g, ''));
      utterance.rate = 1;
      utterance.pitch = 1;
      window.speechSynthesis.speak(utterance);
      statusEl.textContent = 'Reading menu aloud...';
      statusEl.className = 'ok';
    };

    function extractFirstDish(menuText) {
      const lines = menuText.split('\n').map(x => x.trim()).filter(Boolean);
      for (const line of lines) {
        if (line.includes('Breakfast') || line.includes('Lunch') || line.includes('Dinner')) {
          const part = line.split(':')[1] || '';
          const dish = part.split('+')[0].replace(/[üåûü•òüåô*]/g, '').trim();
          if (dish) return dish;
        }
      }
      return 'Indian vegetarian meal';
    }

    async function fetchPexelsImage(query, pexelsKey) {
      const res = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=1`, {
        headers: { Authorization: pexelsKey }
      });
      if (!res.ok) throw new Error('Pexels request failed');
      const data = await res.json();
      return data?.photos?.[0]?.src?.large2x || null;
    }

    async function callGemini(prompt) {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] }
        })
      });

      if (!response.ok) {
        const errorBody = await response.text();
        throw new Error(`Gemini error ${response.status}: ${errorBody}`);
      }

      const data = await response.json();
      return data?.candidates?.[0]?.content?.parts?.map(p => p.text).join('\n') || 'No menu generated.';
    }

    function parseMeals(menuText) {
      const lines = menuText.split('\n').map(x => x.trim());
      const breakfast = lines.find(l => l.toLowerCase().includes('breakfast:')) || '';
      const lunch = lines.find(l => l.toLowerCase().includes('lunch:')) || '';
      const dinner = lines.find(l => l.toLowerCase().includes('dinner:')) || '';
      return {
        breakfast: breakfast.split(':').slice(1).join(':').trim(),
        lunch: lunch.split(':').slice(1).join(':').trim(),
        dinner: dinner.split(':').slice(1).join(':').trim(),
      };
    }

    function renderMealCards() {
      breakfastTextEl.textContent = mealState.breakfast || '-';
      lunchTextEl.textContent = mealState.lunch || '-';
      dinnerTextEl.textContent = mealState.dinner || '-';
      mealCards.style.display = mealState.fullText ? 'block' : 'none';
    }

    function renderFullMenu() {
      mealState.fullText = `Good Morning! Here is today's menu plan:\n\nüåû Breakfast: ${mealState.breakfast || '-'}\nü•ò Lunch: ${mealState.lunch || '-'}\nüåô Dinner: ${mealState.dinner || '-'}`;
      menuEl.textContent = mealState.fullText;
      renderMealCards();
    }

    async function regenerateSingleMeal(mealName) {
      if (!mealState.fullText) {
        statusEl.textContent = 'Generate full menu first.';
        statusEl.className = '';
        return;
      }
      setBusy(true);
      statusEl.textContent = `Reshuffling ${mealName}...`;
      statusEl.className = '';
      try {
        const prefs = prefsEl.value.trim();
        const prompt = `Current menu:\nBreakfast: ${mealState.breakfast}\nLunch: ${mealState.lunch}\nDinner: ${mealState.dinner}\n\nUser preferences: ${prefs || 'None'}\n\nOnly regenerate ${mealName}. Keep other meals unchanged. Return only the new ${mealName} line value without label.`;
        const newMeal = (await callGemini(prompt)).trim().replace(/^[-*\s]+/, '');
        mealState[mealName.toLowerCase()] = newMeal;
        renderFullMenu();
        statusEl.textContent = `${mealName} reshuffled.`;
        statusEl.className = 'ok';
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.className = '';
      } finally {
        setBusy(false);
      }
    }

    reshuffleBreakfastBtn.onclick = () => regenerateSingleMeal('Breakfast');
    reshuffleLunchBtn.onclick = () => regenerateSingleMeal('Lunch');
    reshuffleDinnerBtn.onclick = () => regenerateSingleMeal('Dinner');

    generateBtn.onclick = async () => {
      const prefs = prefsEl.value.trim();
      const pexelsKey = PEXELS_API_KEY;

      localStorage.setItem(STORE_PREFS, prefs);
      setBusy(true);
      statusEl.textContent = 'Generating menu...';
      statusEl.className = '';
      imageEl.style.display = 'none';
      imageNote.textContent = '';

      const day = new Date().toLocaleDateString('en-IN', { weekday: 'long' });
      const prompt = `Today is ${day}.\nUser preferences/dislikes: ${prefs || 'None specified.'}\nGenerate a fresh menu.`;

      try {
        const text = await callGemini(prompt);
        const parsed = parseMeals(text);
        mealState.breakfast = parsed.breakfast;
        mealState.lunch = parsed.lunch;
        mealState.dinner = parsed.dinner;
        renderFullMenu();
        statusEl.textContent = 'Menu generated successfully.';
        statusEl.className = 'ok';

        if (pexelsKey) {
          try {
            const dish = extractFirstDish(text);
            const imageUrl = await fetchPexelsImage(`${dish} indian vegetarian food`, pexelsKey);
            if (imageUrl) {
              imageEl.src = imageUrl;
              imageEl.style.display = 'block';
              imageNote.textContent = `Image based on: ${dish}`;
            } else {
              imageNote.textContent = 'No image found for this dish.';
            }
          } catch {
            imageNote.textContent = 'Image lookup failed. Check Pexels key or try again.';
          }
        } else {
          imageNote.textContent = 'Tip: add Pexels key for a more accurate dish image.';
        }
      } catch (err) {
        menuEl.textContent = 'Failed to generate menu.';
        statusEl.textContent = err.message;
        statusEl.className = '';
      } finally {
        setBusy(false);
      }
    };

    reshuffleAllBtn.onclick = generateBtn.onclick;
  </script>
</body>
</html>
